# Bazel Build System for Agentic

This document describes how to build and test the Agentic project using Bazel.

## Prerequisites

You need one of the following:
- **Bazel** 7.0.0 or later (https://bazel.build/install)
- **Bazelisk** (recommended) - automatically downloads the correct Bazel version

### Installing Bazelisk

**macOS:**
```bash
brew install bazelisk
```

**Linux:**
```bash
wget https://github.com/bazelbuild/bazelisk/releases/latest/download/bazelisk-linux-amd64
chmod +x bazelisk-linux-amd64
sudo mv bazelisk-linux-amd64 /usr/local/bin/bazelisk
# Optionally create a 'bazel' alias
sudo ln -s /usr/local/bin/bazelisk /usr/local/bin/bazel
```

**Windows:**
Download from https://github.com/bazelbuild/bazelisk/releases

## Building

### Build the main binary

```bash
bazel build //cmd:agentic
```

The binary will be located at: `bazel-bin/cmd/agentic_/agentic`

### Run the binary directly

```bash
bazel run //cmd:agentic -- --help
```

Note: Arguments after `--` are passed to the binary.

### Example: Run with arguments

```bash
bazel run //cmd:agentic -- --llm=openai --model=gpt-4-turbo examples/andon.in --output planning
```

## Testing

### Run all tests

```bash
bazel test //...
```

### Run tests for a specific package

```bash
bazel test //cmd:cmd_test
bazel test //internal/llm:llm_test
```

### Run tests with verbose output

```bash
bazel test //... --test_output=all
```

## Managing Dependencies

### Update dependencies from go.mod

When you add or update dependencies in `go.mod` and `go.sum`, regenerate the Bazel dependencies:

```bash
bazel run //:gazelle-update-repos
```

This will update the `deps.bzl` file with the new dependencies.

### Auto-generate BUILD files

If you add new Go files or packages, use Gazelle to automatically generate or update BUILD files:

```bash
bazel run //:gazelle
```

This will:
- Create BUILD.bazel files for new packages
- Update existing BUILD.bazel files with new source files
- Add missing dependencies

### Update both at once

```bash
bazel run //:gazelle-update-repos && bazel run //:gazelle
```

## Clean Build Artifacts

```bash
bazel clean
```

For a complete clean (including external dependencies):

```bash
bazel clean --expunge
```

## Common Commands

| Command | Description |
|---------|-------------|
| `bazel build //cmd:agentic` | Build the main binary |
| `bazel run //cmd:agentic` | Build and run the binary |
| `bazel test //...` | Run all tests |
| `bazel test //cmd:...` | Run tests in cmd package and subpackages |
| `bazel query //...` | List all targets |
| `bazel query 'deps(//cmd:agentic)'` | Show all dependencies of the binary |
| `bazel run //:gazelle` | Auto-generate/update BUILD files |
| `bazel run //:gazelle-update-repos` | Update Go dependencies from go.mod |

## IDE Integration

### VS Code

Install the Bazel extension:
```
code --install-extension BazelBuild.vscode-bazel
```

### IntelliJ / GoLand

Install the Bazel plugin from JetBrains marketplace.

## Troubleshooting

### Build fails with "cannot find package"

Run Gazelle to update dependencies:
```bash
bazel run //:gazelle-update-repos
bazel run //:gazelle
```

### Build cache issues

Clear the cache:
```bash
bazel clean
```

### Network/proxy issues

If you're behind a proxy, configure it in your environment:
```bash
export HTTP_PROXY=http://proxy.example.com:8080
export HTTPS_PROXY=http://proxy.example.com:8080
```

## Comparison with Makefile

The existing Makefile still works. Here's how Bazel commands compare:

| Makefile | Bazel |
|----------|-------|
| `make` | `bazel build //cmd:agentic` |
| `make run` | `bazel run //cmd:agentic` |
| `make clean` | `bazel clean` |
| `go test ./...` | `bazel test //...` |

## Advantages of Bazel

1. **Reproducible builds**: Same inputs always produce the same outputs
2. **Incremental builds**: Only rebuilds what changed
3. **Hermetic builds**: Doesn't depend on system-installed tools
4. **Parallel execution**: Builds and tests run in parallel automatically
5. **Cross-platform**: Works the same on Linux, macOS, and Windows
6. **Scalable**: Handles large codebases efficiently
7. **Remote caching**: Can share build artifacts across teams (if configured)

## Configuration Files

- `WORKSPACE` - Defines the workspace and external dependencies
- `BUILD.bazel` - Build rules for each package
- `.bazelrc` - Bazel configuration options
- `.bazelversion` - Specifies required Bazel version
- `deps.bzl` - Go module dependencies (generated by Gazelle)
- `.bazelignore` - Directories to ignore

## Further Reading

- [Bazel Go Rules](https://github.com/bazelbuild/rules_go)
- [Gazelle Documentation](https://github.com/bazelbuild/bazel-gazelle)
- [Bazel User Guide](https://bazel.build/docs)
